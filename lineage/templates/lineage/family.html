{% extends 'lineage/base.html' %}
{% block content %}
<div class="max-w-[95%] mx-auto px-4 py-8 animate-fade-in">
    
    <div class="flex flex-col lg:flex-row justify-between items-end mb-12 gap-6">
        <div class="space-y-2">
            <h2 class="text-4xl md:text-5xl font-black text-slate-900 dark:text-white tracking-tighter">Family <span class="text-indigo-600">Hub</span></h2>
            <p class="text-slate-500 dark:text-slate-400 font-medium">Click any member to visualize their full lineage tree.</p>
        </div>
        
        <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] shadow-xl border border-slate-100 dark:border-slate-700 flex items-center gap-6 w-full lg:w-auto min-w-[280px]">
            <div class="h-16 w-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shrink-0">
                <i class="fas fa-tree text-2xl"></i>
            </div>
            <div>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Total Directory</p>
                <h3 class="text-4xl font-black text-slate-800 dark:text-white">{{ total_count }}</h3>
            </div>
        </div>
    </div>

    <div class="flex flex-col md:flex-row gap-4 mb-8">
        <div class="relative flex-grow group">
            <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
            <input type="text" id="live-search" placeholder="Search by name, family, or year..." 
                class="w-full pl-14 pr-6 py-4 bg-white dark:bg-slate-900 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-indigo-500 transition-all dark:text-white outline-none"
            >
        </div>
        <button onclick="openAddModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-2xl font-bold transition-all flex items-center justify-center gap-3 shadow-lg shadow-indigo-200 dark:shadow-none whitespace-nowrap">
            <i class="fas fa-user-plus"></i> Add Family Member
        </button>
    </div>

    <div id="no-results" class="hidden flex-col items-center justify-center py-20 text-center">
        <div class="h-20 w-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-slate-400 mb-4">
            <i class="fas fa-user-slash text-3xl"></i>
        </div>
        <h4 class="text-xl font-bold text-slate-700 dark:text-slate-300">No members found</h4>
        <p class="text-slate-500">Try adjusting your search terms.</p>
    </div>

    <div id="table-wrapper" class="bg-white/50 dark:bg-slate-900/50 backdrop-blur-xl rounded-[2.5rem] border border-white dark:border-slate-800 shadow-2xl overflow-hidden">
        <div class="overflow-x-auto scrollbar-hide">
            <table class="w-full text-left border-collapse min-w-[750px]">
                <thead>
                    <tr class="bg-slate-50/50 dark:bg-slate-800/50 text-slate-400 uppercase text-[11px] tracking-[0.2em] font-bold">
                        <th class="px-8 py-6">Family Member</th>
                        <th class="px-8 py-6">Family</th>
                        <th class="px-8 py-6">Birth Year</th>
                        <th class="px-8 py-6 text-right">Lineage</th>
                    </tr>
                </thead>
                <tbody id="directory-body" class="divide-y divide-slate-100 dark:divide-slate-800">
                    {% for member in members %}
                    <tr class="group hover:bg-white dark:hover:bg-slate-800 transition-all cursor-pointer member-row" 
                        onclick="showTree('{{ member.id }}', '{{ member.name }}')">
                        <td class="px-8 py-5">
                            <div class="flex items-center gap-4">
                                <div class="h-10 w-10 shrink-0 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold">
                                    {{ member.name|slice:":1" }}
                                </div>
                                <div class="flex flex-col">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-slate-700 dark:text-slate-200 whitespace-nowrap searchable-name">{{ member.name }}</span>
                                        {% if member.gender == 'male' %}
                                            <i class="fas fa-mars text-blue-500 text-xs shrink-0"></i>
                                        {% else %}
                                            <i class="fas fa-venus text-pink-500 text-xs shrink-0"></i>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-8 py-5">
                            <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-tighter whitespace-nowrap searchable-type
                                {% if member.type == 'Parent' %}bg-amber-100 text-amber-700{% else %}bg-sky-100 text-sky-700{% endif %}">
                                {{ member.type }}
                            </span>
                        </td>
                        <td class="px-8 py-5 text-slate-500 dark:text-slate-400 font-medium whitespace-nowrap searchable-year">{{ member.date|date:"Y" }}</td>
                        <td class="px-8 py-5 text-right">
                            <button class="bg-slate-100 dark:bg-slate-700 h-10 w-10 rounded-xl text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-all inline-flex items-center justify-center">
                                <i class="fas fa-sitemap"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="addMemberModal" class="fixed inset-0 z-[110] flex items-center justify-center hidden bg-slate-900/60 backdrop-blur-md p-4">
    <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden animate-tree-pop max-h-[90vh] overflow-y-auto scrollbar-hide">
        <div class="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-indigo-50/50 dark:bg-indigo-900/20 sticky top-0 z-10 backdrop-blur-md">
            <div>
                <h3 class="text-2xl font-black text-slate-900 dark:text-white">New Member</h3>
                <p class="text-indigo-600 font-bold uppercase text-[10px] tracking-widest">Expand the Lineage</p>
            </div>
            <button onclick="closeAddModal()" class="text-slate-400 hover:text-red-500 transition-colors">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <form class="p-8 space-y-5" method="POST" action="#">
            {% csrf_token %}
            <div>
                <label class="block text-xs font-black uppercase tracking-widest text-slate-400 mb-2">Family Name</label>
                <input type="text" name="family_name" required placeholder="e.g. Usunye"
                    class="w-full px-5 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition-all outline-none">
            </div>

            <div>
                <label class="block text-xs font-black uppercase tracking-widest text-slate-400 mb-2">Full Name</label>
                <input type="text" name="member_name" required placeholder="Enter name"
                    class="w-full px-5 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition-all outline-none">
            </div>

            <div>
                <label class="block text-xs font-black uppercase tracking-widest text-slate-400 mb-2">Parent / Guardian</label>
                <select name="parent_id" class="w-full px-5 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition-all outline-none">
                    <option value="">Select Parent/Guardian</option>
                    {% for parent in all_parents_list %}
                        <option value="{{ parent.id }}">{{ parent.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <label class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800 cursor-pointer border-2 border-transparent has-[:checked]:border-indigo-500 transition-all">
                    <input type="radio" name="gender" value="male" class="hidden" checked>
                    <i class="fas fa-mars text-blue-500"></i>
                    <span class="text-sm font-bold text-slate-600 dark:text-slate-300">Male</span>
                </label>
                <label class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800 cursor-pointer border-2 border-transparent has-[:checked]:border-indigo-500 transition-all">
                    <input type="radio" name="gender" value="female" class="hidden">
                    <i class="fas fa-venus text-pink-500"></i>
                    <span class="text-sm font-bold text-slate-600 dark:text-slate-300">Female</span>
                </label>
            </div>

            <button type="submit" class="w-full bg-indigo-600 py-4 rounded-2xl text-white font-black uppercase tracking-widest hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 dark:shadow-none mt-4">
                Save Member
            </button>
        </form>
    </div>
</div>

<div id="treeModal" class="fixed inset-0 z-[100] flex items-center justify-center hidden bg-slate-900/90 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden animate-tree-pop max-h-[90vh] overflow-y-auto">
        <div class="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center sticky top-0 bg-white dark:bg-slate-900 z-20">
            <div>
                <h3 id="modalName" class="text-3xl font-black text-slate-900 dark:text-white">Family Member</h3>
                <p class="text-indigo-600 font-bold uppercase text-xs tracking-widest">Lineage Visualization</p>
            </div>
            <button onclick="closeTree()" class="h-12 w-12 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-xl text-slate-500 hover:bg-red-500 hover:text-white transition-all">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-10 bg-slate-50/50 dark:bg-slate-950/50 relative min-h-[400px]">
            <div id="tree-loader" class="absolute inset-0 z-10 flex items-center justify-center bg-white/80 dark:bg-slate-900/80 transition-opacity">
                <div class="flex flex-col items-center gap-4">
                    <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                    <p class="text-indigo-600 font-bold animate-pulse text-xs uppercase tracking-tighter">Fetching Lineage...</p>
                </div>
            </div>

            <div class="relative">
                <div class="absolute left-6 top-0 bottom-0 w-1 bg-gradient-to-b from-indigo-500 via-purple-500 to-pink-500 rounded-full"></div>
                <div class="space-y-12">
                    <div class="relative pl-16">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 rounded-full bg-white border-4 border-indigo-500 z-10"></div>
                        <p class="text-[10px] font-black text-indigo-500 uppercase tracking-[0.2em]">Great Grandfather</p>
                        <h4 id="greatGrandfatherName" class="text-xl font-bold text-slate-700 dark:text-slate-300">---</h4>
                    </div>
                    <div class="relative pl-16">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 rounded-full bg-white border-4 border-purple-500 z-10"></div>
                        <p class="text-[10px] font-black text-purple-500 uppercase tracking-[0.2em]">Grandfather</p>
                        <h4 id="grandfatherName" class="text-xl font-bold text-slate-700 dark:text-slate-300">---</h4>
                    </div>
                    <div class="relative pl-16 scale-110 origin-left">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-indigo-600 border-4 border-white shadow-lg z-10"></div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Current Member</p>
                        <h4 id="treeTargetName" class="text-2xl font-black text-indigo-600">Name</h4>
                    </div>
                    <div class="relative pl-16">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 rounded-full bg-white border-4 border-pink-500 z-10"></div>
                        <p class="text-[10px] font-black text-pink-500 uppercase tracking-[0.2em]">Offspring</p>
                        <h4 id="offspringName" class="text-xl font-bold text-slate-700 dark:text-slate-300">---</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    @keyframes treePop {
        from { opacity: 0; transform: scale(0.9) translateY(30px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .animate-tree-pop { animation: treePop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    
    tr:hover .fa-mars { color: #3b82f6; transform: scale(1.2); }
    tr:hover .fa-venus { color: #ec4899; transform: scale(1.2); }
</style>

<script>
    document.getElementById('live-search').addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase().trim();
        const rows = document.querySelectorAll('.member-row');
        const noResults = document.getElementById('no-results');
        const tableWrapper = document.getElementById('table-wrapper');
        let hasMatch = false;

        rows.forEach(row => {
            const name = row.querySelector('.searchable-name').innerText.toLowerCase();
            const type = row.querySelector('.searchable-type').innerText.toLowerCase();
            const year = row.querySelector('.searchable-year').innerText.toLowerCase();
            
            if (name.includes(term) || type.includes(term) || year.includes(term)) {
                row.style.display = '';
                hasMatch = true;
            } else {
                row.style.display = 'none';
            }
        });

        if (!hasMatch) {
            tableWrapper.classList.add('hidden');
            noResults.classList.remove('hidden');
            noResults.classList.add('flex');
        } else {
            tableWrapper.classList.remove('hidden');
            noResults.classList.add('hidden');
            noResults.classList.remove('flex');
        }
    });

    function showTree(memberId, name) {
        const modal = document.getElementById('treeModal');
        const loader = document.getElementById('tree-loader');
        document.getElementById('modalName').innerText = name;
        document.getElementById('treeTargetName').innerText = name;
        document.getElementById('greatGrandfatherName').innerText = "---";
        document.getElementById('grandfatherName').innerText = "---";
        document.getElementById('offspringName').innerText = "---";
        modal.classList.remove('hidden');
        loader.classList.remove('hidden');
        loader.style.opacity = '1';
        fetch(`/get-lineage/${memberId}/`)
            .then(response => response.json())
            .then(data => {
                setTimeout(() => {
                    document.getElementById('greatGrandfatherName').innerText = data.great_grandfather || "Not Available";
                    document.getElementById('grandfatherName').innerText = data.grandfather || "Not Available";
                    document.getElementById('offspringName').innerText = data.offspring_summary || "None Recorded";
                    loader.style.opacity = '0';
                    setTimeout(() => loader.classList.add('hidden'), 300);
                }, 600);
            })
            .catch(err => {
                console.error("Lineage Fetch Error:", err);
                loader.classList.add('hidden');
            });
    }

    function closeTree() {
        document.getElementById('treeModal').classList.add('hidden');
    }

    function openAddModal() {
        document.getElementById('addMemberModal').classList.remove('hidden');
    }
    function closeAddModal() {
        document.getElementById('addMemberModal').classList.add('hidden');
    }
</script>
{% endblock %}