{% extends 'lineage/base.html' %}

{% block title %}Events & Contributions{% endblock %}

{% block content %}

<div class="animate__animated animate__fadeIn space-y-10">

  <!-- Header -->

  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
      <h2 class="text-2xl font-bold text-slate-800">Family Events & Contributions</h2>
      <p class="text-slate-500 text-sm">Create events and track member contributions</p>
    </div>
    <button id="openEventModal" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow flex items-center gap-2">
      <i class="fas fa-plus"></i> Add Event
    </button>
  </div>

  <!-- Events Grid -->

  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
    {% for event in events %}
    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm hover:shadow-md transition cursor-pointer" onclick="openEvent('{{ event.id }}')">
      <div class="p-6 space-y-4">
        <div class="flex justify-between items-start">
          <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide
            {% if event.type == 'Wedding' %}bg-pink-100 text-pink-600
            {% elif event.type == 'Party' %}bg-amber-100 text-amber-600
            {% elif event.type == 'Funeral' %}bg-slate-200 text-slate-700
            {% else %}bg-indigo-100 text-indigo-600{% endif %}">
            {{ event.type }}
          </span>
          <span class="text-xs text-slate-400">{{ event.date|date:"M d, Y" }}</span>
        </div>


    <div>
      <h3 class="text-lg font-bold text-slate-800">{{ event.title }}</h3>
      <p class="text-sm text-slate-500">Family: {{ event.family_name }}</p>
      <p class="text-sm text-slate-500">Place: {{ event.location }}</p>
    </div>

    <div class="flex justify-between items-end pt-4 border-t">
      <div>
        <p class="text-xs text-slate-400 uppercase font-bold">Target Amount</p>
        <p class="text-xl font-extrabold text-emerald-600">Ksh {{ event.goal_amount }}</p>
      </div>
      <div class="text-right">
        <p class="text-xs text-slate-400 uppercase font-bold">Raised</p>
        <p class="text-sm font-bold text-slate-700">Ksh {{ event.total_contributed }}</p>
      </div>
    </div>
  </div>
</div>
{% empty %}
<p class="text-slate-400 italic">No events created yet.</p>
{% endfor %}


  </div>

</div>

<!-- Event Drawer -->

<div id="eventDrawer" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50">
  <div class="absolute right-0 top-0 h-full w-full max-w-3xl bg-white shadow-2xl animate__animated animate__slideInRight flex flex-col">


<div class="p-6 border-b flex justify-between items-center">
  <div>
    <h3 id="drawerTitle" class="text-xl font-bold text-slate-800"></h3>
    <p id="drawerMeta" class="text-sm text-slate-500"></p>
  </div>
  <button onclick="closeDrawer()" class="text-slate-400 hover:text-slate-700">
    <i class="fas fa-times text-xl"></i>
  </button>
</div>

<div class="p-6 space-y-6 overflow-y-auto">
  <div class="flex justify-between items-center">
    <h4 class="font-bold text-slate-700">Contributors</h4>
    <button id="openContributionModal" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700">
      <i class="fas fa-user-plus"></i> Add Contributor
    </button>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full border rounded-xl overflow-hidden">
      <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold">
        <tr>
          <th class="px-4 py-3 text-left">Member</th>
          <th class="px-4 py-3">Amount</th>
          <th class="px-4 py-3">Date</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for c in selected_event.details.all %}
        <tr>
          <td class="px-4 py-3 font-medium text-slate-700">{{ c.member_name }}</td>
          <td class="px-4 py-3 font-bold text-emerald-600">Ksh {{ c.amount }}</td>
          <td class="px-4 py-3 text-sm text-slate-500">{{ c.created_at|date:"M d, Y" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="3" class="px-4 py-6 text-center text-slate-400 italic">No contributors yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


  </div>
</div>


<div id="eventModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden">
    <div class="bg-indigo-600 p-6 text-white text-center">
      <h3 class="text-xl font-bold">Create New Event</h3>
    </div>
    <form method="post" action="{% url 'add_event' %}" class="p-6 space-y-4">
      {% csrf_token %}
      {{ event_form.as_p }}
      <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Save Event</button>
      <button type="button" onclick="closeEventModal()" class="w-full text-sm text-slate-400">Cancel</button>
    </form>
  </div>
</div>

<!-- Add Contribution Modal -->

<div id="contributionModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden">
    <div class="bg-emerald-600 p-6 text-white text-center">
      <h3 class="text-xl font-bold">Add Contribution</h3>
    </div>
    <form method="post" action="{% url 'add_contribution' %}" class="p-6 space-y-4">
      {% csrf_token %}
      {{ contribution_form.as_p }}
      <button class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">Save Contribution</button>
      <button type="button" onclick="closeContributionModal()" class="w-full text-sm text-slate-400">Cancel</button>
    </form>
  </div>
</div>

<script>
  const eventDrawer = document.getElementById('eventDrawer');
  const eventModal = document.getElementById('eventModal');
  const contributionModal = document.getElementById('contributionModal');

  function openEvent(id) {
    eventDrawer.classList.remove('hidden');
  }

  function closeDrawer() {
    eventDrawer.classList.add('hidden');
  }

  document.getElementById('openEventModal').onclick = () => eventModal.classList.remove('hidden');
  function closeEventModal() { eventModal.classList.add('hidden'); }

  document.getElementById('openContributionModal').onclick = () => contributionModal.classList.remove('hidden');
  function closeContributionModal() { contributionModal.classList.add('hidden'); }
</script>

{% endblock %}


<script>
  function calculateProgress(raised, goal) {
    return Math.min(100, Math.round((raised / goal) * 100));
  }
</script>
